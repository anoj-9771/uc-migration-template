/*
Deployment script for ZEASQLDBEDW01

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ZEASQLDBEDW01"
:setvar DefaultFilePrefix "ZEASQLDBEDW01"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367)) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE = OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
/*
 Pre-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be executed before the build script.	
 Use SQLCMD syntax to include a file in the pre-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the pre-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/
GO

GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [ADDRESS_LINE_1] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [ADDRESS_LINE_2] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [ADDRESS_LINE_3] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [FES_FULL_NAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [HEALTH_SAFETY_CERT_EXP_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [HEALTH_SAFETY_STATUS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [LIABILITY_INS_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_ORGANISATION_UNITS] ALTER COLUMN [TELEPHONE_NUMBER] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_PEOPLE]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [ASSES_FORM_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [AUTHORITY_TO_ENROL_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [CNX_CARDHOLDER_ID] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [COLLEGE_EMAIL] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [CONCESSION_CODE_EXPIRY] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [DATE_OF_BIRTH] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [ELECTRONIC_PAYMENT_REF_NO] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [ETHNICITY] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [EXPORT_ACCEPTANCE_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [MEDICAL_NO] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [MOBILE_PHONE_NUMBER] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [NZ_ETHNICITY_1] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [NZ_ETHNICITY_2] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [NZ_ETHNICITY_3] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [PASSPORT_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [PASSPORT_ISSUE_COUNTRY] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [PASSPORT_NO] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [PERSONAL_EMAIL] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [PREFERRED_FIRST_NAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [PREVIOUS_SURNAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [SURNAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE] ALTER COLUMN [TAX_FILE_NO] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_PEOPLE_ASR]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_ASR] ALTER COLUMN [HOME_TELEPHONE_NUMBER] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_ASR] ALTER COLUMN [WORK_TELEPHONE_NUMBER] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_PEOPLE_UNITS]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [AMNT_PRIOR_LRN_CREDIT_OFFERED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [AMNT_PRIOR_LRN_CREDIT_USED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [EXTERNAL_SUBSIDISED_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [HE_PRIOR_LRN_CREDIT_PROVIDER] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [LOAN_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [PRIOR_FOE_CREDIT_OFFERED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [PRIOR_LOE_CREDIT_OFFERED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [PRIOR_STUDY_CREDIT_OFFERED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [STANDARD_SUBSIDY_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [SUBSIDISED_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [SUBSIDY_COMMITMENT_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS] ALTER COLUMN [SUBSIDY_EXPORT_DATE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_PEOPLE_UNITS_FINANCIAL]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS_FINANCIAL] ALTER COLUMN [STUDENT_FEE_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_PEOPLE_UNITS_SPECIAL]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS_SPECIAL] ALTER COLUMN [CREDIT_ACHIEVED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS_SPECIAL] ALTER COLUMN [FUNDING_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_UNITS_SPECIAL] ALTER COLUMN [PLANNED_CREDIT] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_PEOPLE_USI]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_PEOPLE_USI] ALTER COLUMN [CITY_OF_BIRTH] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_REGISTER_EVENT_DETAILS_SLOTS]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_REGISTER_EVENT_DETAILS_SLOTS] ALTER COLUMN [AMOUNT_CLAIMED] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_SCHOOLS]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [ADDRESS_LINE_1] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [ADDRESS_LINE_2] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [ADDRESS_LINE_3] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [ADDRESS_LINE_4] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [EMAIL_ADDRESS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [FULL_NAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [HEAD_SURNAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_SCHOOLS] ALTER COLUMN [TELEPHONE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_UNIT_INSTANCE_OCCURRENCES]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCE_OCCURRENCES] ALTER COLUMN [COURSE_CREDITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCE_OCCURRENCES] ALTER COLUMN [DEFAULT_VTO_CODE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCE_OCCURRENCES] ALTER COLUMN [MIN_CREDITS_REQUIRED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCE_OCCURRENCES] ALTER COLUMN [PAYMENT_DUE_DATE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_UNIT_INSTANCES]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [ACCREDITATION_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [ACCREDITATION_TYPE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [ACCREDITED_HOURS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [ACCREDITED_UNITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [CATS_CREDITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [COURSE_CREDITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [MIN_CREDITS_REQUIRED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [UNIT_CURRENCY_MONTHS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [UNIT_CURRENCY_YEARS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_UNIT_INSTANCES] ALTER COLUMN [VTO_CODE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_USERS]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_USERS] ALTER COLUMN [DIALINUSERNAME] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_USERS] ALTER COLUMN [IPADDRESS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_USERS] ALTER COLUMN [PASS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_USERS] ALTER COLUMN [PASSEXPIRYDATE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_VISA_SUBCLASSES]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_VISA_SUBCLASSES] ALTER COLUMN [VISA_CLASS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_VISA_SUBCLASSES] ALTER COLUMN [VISA_TYPE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_VISAS]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_VISAS] ALTER COLUMN [EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_VISAS] ALTER COLUMN [VISA_HOLDER_CODE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_VISAS] ALTER COLUMN [VISA_LABEL_NO] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_VISAS] ALTER COLUMN [VISA_SUB_CLASS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_VISAS] ALTER COLUMN [VISA_TYPE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_WEB_CONFIG]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_WEB_CONFIG] ALTER COLUMN [AREA_CODE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0165_Z_READ_BATCHES]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0165_Z_READ_BATCHES] ALTER COLUMN [BANKING_DEPOSIT_NO] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0165_Z_READ_BATCHES] ALTER COLUMN [BANKING_GROUP_ID] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[OneEBS_EBS_0900_UNIT_INSTANCES]...';


GO
ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [ACCREDITATION_EXPIRY_DATE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [ACCREDITATION_TYPE] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [ACCREDITED_HOURS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [ACCREDITED_UNITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [CATS_CREDITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [COURSE_CREDITS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [MIN_CREDITS_REQUIRED] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [UNIT_CURRENCY_MONTHS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [UNIT_CURRENCY_YEARS] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[OneEBS_EBS_0900_UNIT_INSTANCES] ALTER COLUMN [VTO_CODE] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[Prada_dbo_COURSE_ENROLMENTS]...';


GO
ALTER TABLE [edw].[Prada_dbo_COURSE_ENROLMENTS] ALTER COLUMN [PASSTOT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[Prada_dbo_COURSE_ENROLMENTS] ALTER COLUMN [SS_STANDARD_SUBSIDY_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[Prada_dbo_COURSE_ENROLMENTS] ALTER COLUMN [SS_SUBSIDY_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[Prada_dbo_COURSE_ENROLMENTS_FINALS]...';


GO
ALTER TABLE [edw].[Prada_dbo_COURSE_ENROLMENTS_FINALS] ALTER COLUMN [PASSTOT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[Prada_dbo_COURSE_ENROLMENTS_FINALS] ALTER COLUMN [SS_STANDARD_SUBSIDY_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[Prada_dbo_COURSE_ENROLMENTS_FINALS] ALTER COLUMN [SS_SUBSIDY_AMOUNT] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[reference_date]...';


GO
ALTER TABLE [edw].[reference_date] ALTER COLUMN [DateFullName] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[reference_funding_source_sbi_rules]...';


GO
ALTER TABLE [edw].[reference_funding_source_sbi_rules] ALTER COLUMN [Rule1_FundingSourceNationalID] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[reference_funding_source_sbi_rules] ALTER COLUMN [Rule10_FundingSourceNationalID] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[reference_funding_source_sbi_rules] ALTER COLUMN [Rule2_FundingSourceNationalID] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[reference_funding_source_sbi_rules] ALTER COLUMN [Rule9_FundingSourceNationalID] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[reference_ts_nsw_fund_group]...';


GO
ALTER TABLE [edw].[reference_ts_nsw_fund_group] ALTER COLUMN [FundingSourceNationalID] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[UMD_FactUnenteredMarks]...';


GO
ALTER TABLE [edw].[UMD_FactUnenteredMarks] ALTER COLUMN [CId] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[UMD_FactUnenteredMarks] ALTER COLUMN [FirstName] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[UMD_FactUnenteredMarks] ALTER COLUMN [LastName] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[UMD_FactUnenteredMarks] ALTER COLUMN [TeacherADEmail] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[UMD_FactUnenteredMarks] ALTER COLUMN [TeacherADUserName] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[UMD_TempTeachersMarks]...';


GO
ALTER TABLE [edw].[UMD_TempTeachersMarks] ALTER COLUMN [cid] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[UMD_TempTeachersMarks] ALTER COLUMN [First_Name] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [edw].[UMD_TempTeachersMarks] ALTER COLUMN [Last_Name] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [edw].[VCPexip_conference]...';


GO
ALTER TABLE [edw].[VCPexip_conference] ALTER COLUMN [_DLRawZoneTimeStamp] DATETIME2 (7) NULL;

ALTER TABLE [edw].[VCPexip_conference] ALTER COLUMN [_DLTrustedZoneTimeStamp] DATETIME2 (7) NULL;

ALTER TABLE [edw].[VCPexip_conference] ALTER COLUMN [_RecordEnd] DATETIME2 (7) NULL;

ALTER TABLE [edw].[VCPexip_conference] ALTER COLUMN [_RecordStart] DATETIME2 (7) NULL;


GO
PRINT N'Altering Table [edw].[VCPexip_participant]...';


GO
ALTER TABLE [edw].[VCPexip_participant] ALTER COLUMN [_DLRawZoneTimeStamp] DATETIME2 (7) NULL;

ALTER TABLE [edw].[VCPexip_participant] ALTER COLUMN [_DLTrustedZoneTimeStamp] DATETIME2 (7) NULL;

ALTER TABLE [edw].[VCPexip_participant] ALTER COLUMN [_RecordEnd] DATETIME2 (7) NULL;

ALTER TABLE [edw].[VCPexip_participant] ALTER COLUMN [_RecordStart] DATETIME2 (7) NULL;


GO
ALTER TABLE [edw].[VCPexip_participant] ALTER COLUMN [remote_address] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [tsEChecklist].[ChecklistActions]...';


GO
ALTER TABLE [tsEChecklist].[ChecklistActions] ALTER COLUMN [DOB] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [tsEChecklist].[ChecklistActions] ALTER COLUMN [FirstName] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [tsEChecklist].[ChecklistActions] ALTER COLUMN [LastName] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [tsEChecklist].[ChecklistActions] ALTER COLUMN [VTO] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Altering Table [tsEChecklist].[ChecklistActionsInvalidRecords]...';


GO
ALTER TABLE [tsEChecklist].[ChecklistActionsInvalidRecords] ALTER COLUMN [DOB] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [tsEChecklist].[ChecklistActionsInvalidRecords] ALTER COLUMN [FirstName] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [tsEChecklist].[ChecklistActionsInvalidRecords] ALTER COLUMN [LastName] ADD MASKED WITH (FUNCTION = 'default()');

ALTER TABLE [tsEChecklist].[ChecklistActionsInvalidRecords] ALTER COLUMN [VTO] ADD MASKED WITH (FUNCTION = 'default()');


GO
PRINT N'Creating Table [edw].[EBS_EnrolmentsAndFees]...';


GO
CREATE TABLE [edw].[EBS_EnrolmentsAndFees] (
    [Region]                     VARCHAR (100)   NULL,
    [SubRegion]                  VARCHAR (8000)  NULL,
    [Location]                   VARCHAR (10)    NULL,
    [LearnerNo]                  VARCHAR (20)    NULL,
    [PersonCode]                 NUMERIC (10)    NULL,
    [Surname]                    VARCHAR (50)    NULL,
    [FirstName]                  VARCHAR (50)    NULL,
    [USI]                        VARCHAR (10)    NULL,
    [DateUSIverified]            DATETIME2 (7)   NULL,
    [DateOfBirth]                DATETIME2 (7)   NULL,
    [AgeAtEnrolment]             INT             NULL,
    [CampusName]                 VARCHAR (40)    NULL,
    [FacultyName]                VARCHAR (100)   NULL,
    [CourseCode]                 VARCHAR (20)    NULL,
    [CalOccCode]                 VARCHAR (10)    NULL,
    [CourseName]                 VARCHAR (255)   NULL,
    [EnrolmentStartDate]         DATETIME2 (7)   NULL,
    [EnrolmentEndDate]           DATETIME2 (7)   NULL,
    [ProgressCode]               VARCHAR (10)    NULL,
    [ProgressDate]               DATETIME2 (7)   NULL,
    [Progress]                   VARCHAR (40)    NULL,
    [ReasonCode]                 VARCHAR (40)    NULL,
    [ProgressReason]             VARCHAR (1000)  NULL,
    [FundingSource]              VARCHAR (5)     NULL,
    [FundingDescription]         VARCHAR (1000)  NULL,
    [CommitmentIdentifier]       VARCHAR (12)    NULL,
    [CID_Status]                 VARCHAR (40)    NULL,
    [A_T_Flag]                   VARCHAR (240)   NULL,
    [ApprenticeTrainee]          VARCHAR (1000)  NULL,
    [ApprenticeTraineeType]      VARCHAR (1000)  NULL,
    [TCID]                       VARCHAR (10)    NULL,
    [UIO_ID]                     NUMERIC (10)    NULL,
    [OfferingType]               VARCHAR (10)    NULL,
    [OfferingTypeDesc]           VARCHAR (1000)  NULL,
    [OfferingCode]               VARCHAR (240)   NULL,
    [TeachingSection]            VARCHAR (100)   NULL,
    [TSN_StudentFee]             NUMERIC (15, 2) NULL,
    [TSN_FeeTypeIndicator]       VARCHAR (40)    NULL,
    [TSN_FeeTypeIndicatorDesc]   VARCHAR (1000)  NULL,
    [FeeWaivers]                 VARCHAR (8000)  NULL,
    [EnrolmentWaivers]           VARCHAR (8000)  NULL,
    [EBS_CurrentFee]             NUMERIC (38, 2) NULL,
    [ebsFeeExist]                VARCHAR (1)     NOT NULL,
    [WhoToPay]                   VARCHAR (10)    NULL,
    [PostCode]                   VARCHAR (4)     NULL,
    [ResidentialState]           VARCHAR (32)    NULL,
    [ResidentialLocality]        VARCHAR (50)    NULL,
    [HighestPostSchoolQual]      VARCHAR (1)     NULL,
    [PostSchoolQualification]    VARCHAR (1000)  NULL,
    [WelfareStatus]              VARCHAR (1)     NULL,
    [PrimaryCRN]                 VARCHAR (10)    NULL,
    [SecondaryCRN]               VARCHAR (10)    NULL,
    [QualificationLevel]         VARCHAR (1000)  NULL,
    [NationalCourseCode]         VARCHAR (20)    NULL,
    [RESIDENTIAL_STATUS]         VARCHAR (10)    NULL,
    [ResidentialStatus]          VARCHAR (1000)  NULL,
    [CurrEMPstatus]              VARCHAR (2)     NULL,
    [EmploymentStatus]           VARCHAR (1000)  NULL,
    [WorksInNSW]                 VARCHAR (240)   NULL,
    [ESPclient]                  VARCHAR (1)     NULL,
    [ESPOrganistaion]            VARCHAR (3)     NULL,
    [EmploymentServicesProvider] VARCHAR (1000)  NULL,
    [ESPreferral]                VARCHAR (1)     NULL,
    [ESPReferralIDentifier]      VARCHAR (10)    NULL,
    [IndigenousStatus]           VARCHAR (1000)  NULL,
    [Disability]                 VARCHAR (1000)  NULL,
    [DisabilityAssessment]       VARCHAR (1000)  NULL,
    [PU_ID]                      NUMERIC (10)    NULL,
    [PersonalEmail]              VARCHAR (100)   NULL,
    [TAFEemail]                  VARCHAR (128)   NULL,
    [TAFEID]                     VARCHAR (30)    NULL,
    [Mobile]                     VARCHAR (22)    NULL,
    [DataLoadDate]               DATETIME        NOT NULL,
    [OfferingStart]              DATETIME2 (7)   NULL,
    [OfferingEnd]                DATETIME2 (7)   NULL,
    [DtApplied]                  DATETIME2 (7)   NULL,
    [DtEnrolled]                 DATETIME2 (7)   NULL,
    [FacultyCode]                VARCHAR (30)    NULL,
    [ProgressType]               VARCHAR (1)     NULL,
    [DateFirstActive]            DATETIME2 (7)   NULL,
    [UniqueID]                   BIGINT          IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_EnrolmentsAndFee] PRIMARY KEY CLUSTERED ([UniqueID] ASC)
);


GO
PRINT N'Refreshing View [compliance].[vwAvetmissCourseEnrolment_ReprocessOldPrada]...';


GO
EXECUTE sp_refreshsqlmodule N'[compliance].[vwAvetmissCourseEnrolment_ReprocessOldPrada]';


GO
PRINT N'Refreshing View [compliance].[vwAvetmissUnitEnrolmentFinals]...';


GO
EXECUTE sp_refreshsqlmodule N'[compliance].[vwAvetmissUnitEnrolmentFinals]';


GO
PRINT N'Refreshing View [OneEBS].[Organisation_Units]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Organisation_Units]';


GO
PRINT N'Refreshing View [OneEBS].[People]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[People]';


GO
PRINT N'Refreshing View [OneEBS].[People_ASR]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[People_ASR]';


GO
PRINT N'Refreshing View [OneEBS].[People_Units]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[People_Units]';


GO
PRINT N'Refreshing View [OneEBS].[People_Units_Financial]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[People_Units_Financial]';


GO
PRINT N'Refreshing View [OneEBS].[People_Units_Special]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[People_Units_Special]';


GO
PRINT N'Refreshing View [OneEBS].[People_USI]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[People_USI]';


GO
PRINT N'Refreshing View [OneEBS].[Register_Event_Details_Slots]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Register_Event_Details_Slots]';


GO
PRINT N'Refreshing View [OneEBS].[Schools]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Schools]';


GO
PRINT N'Refreshing View [OneEBS].[Unit_Instance_Occurrences]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Unit_Instance_Occurrences]';


GO
PRINT N'Refreshing View [OneEBS].[Unit_Instances]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Unit_Instances]';


GO
PRINT N'Refreshing View [OneEBS].[Users]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Users]';


GO
PRINT N'Refreshing View [OneEBS].[Visa_Subclasses]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Visa_Subclasses]';


GO
PRINT N'Refreshing View [OneEBS].[Visas]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Visas]';


GO
PRINT N'Refreshing View [OneEBS].[Web_Config]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Web_Config]';


GO
PRINT N'Refreshing View [OneEBS].[Z_Read_Batches]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[Z_Read_Batches]';


GO
PRINT N'Refreshing View [OneEBS].[900_Unit_Instances]...';


GO
EXECUTE sp_refreshsqlmodule N'[OneEBS].[900_Unit_Instances]';


GO
PRINT N'Refreshing View [reference].[Date]...';


GO
EXECUTE sp_refreshsqlmodule N'[reference].[Date]';


GO
PRINT N'Refreshing View [reference].[FundingSourceSbiRules]...';


GO
EXECUTE sp_refreshsqlmodule N'[reference].[FundingSourceSbiRules]';


GO
PRINT N'Refreshing View [reference].[TsNswFundGroup]...';


GO
EXECUTE sp_refreshsqlmodule N'[reference].[TsNswFundGroup]';


GO
PRINT N'Refreshing View [compliance].[vwAvetmissCourseEnrolment]...';


GO
EXECUTE sp_refreshsqlmodule N'[compliance].[vwAvetmissCourseEnrolment]';


GO
PRINT N'Refreshing View [compliance].[vwAvetmissUnitCourseEnrolment]...';


GO
EXECUTE sp_refreshsqlmodule N'[compliance].[vwAvetmissUnitCourseEnrolment]';


GO
PRINT N'Refreshing View [reference].[FundingSourceExtended]...';


GO
EXECUTE sp_refreshsqlmodule N'[reference].[FundingSourceExtended]';


GO
PRINT N'Refreshing View [VCPexip].[VCConferenceDetail]...';


GO
EXECUTE sp_refreshsqlmodule N'[VCPexip].[VCConferenceDetail]';


GO
PRINT N'Refreshing View [VCPexip].[VCParticipantDetail]...';


GO
EXECUTE sp_refreshsqlmodule N'[VCPexip].[VCParticipantDetail]';


GO
PRINT N'Refreshing View [EChecklist].[ChecklistActions]...';


GO
EXECUTE sp_refreshsqlmodule N'[EChecklist].[ChecklistActions]';


GO
PRINT N'Refreshing View [EChecklist].[EChecklistExceptionReport]...';


GO
EXECUTE sp_refreshsqlmodule N'[EChecklist].[EChecklistExceptionReport]';


GO
PRINT N'Altering View [OneEBS].[EnrolmentsAndFees]...';


GO
ALTER VIEW [OneEBS].[EnrolmentsAndFees]
AS
SELECT [Region]
      ,[SubRegion]
      ,[Location]
      ,[LearnerNo]
      ,[PersonCode]
      ,[Surname]
      ,[FirstName]
      ,[USI]
      ,[DateUSIverified]
      ,[DateOfBirth]
      ,[AgeAtEnrolment]
      ,[CampusName]
      ,[FacultyName]
      ,[CourseCode]
      ,[CalOccCode]
      ,[CourseName]
      ,[EnrolmentStartDate]
      ,[EnrolmentEndDate]
      ,[ProgressCode]
      ,[ProgressDate]
      ,[Progress]
      ,[ReasonCode]
      ,[ProgressReason]
      ,[FundingSource]
      ,[FundingDescription]
      ,[CommitmentIdentifier]
      ,[CID_Status]
      ,[A_T_Flag]
      ,[ApprenticeTrainee]
      ,[ApprenticeTraineeType]
      ,[TCID]
      ,[UIO_ID]
      ,[OfferingType]
      ,[OfferingTypeDesc]
      ,[OfferingCode]
      ,[TeachingSection]
      ,[TSN_StudentFee]
      ,[TSN_FeeTypeIndicator]
      ,[TSN_FeeTypeIndicatorDesc]
      ,[FeeWaivers]
      ,[EnrolmentWaivers]
      ,[EBS_CurrentFee]
      ,[ebsFeeExist]
      ,[WhoToPay]
      ,[PostCode]
      ,[ResidentialState]
      ,[ResidentialLocality]
      ,[HighestPostSchoolQual]
      ,[PostSchoolQualification]
      ,[WelfareStatus]
      ,[PrimaryCRN]
      ,[SecondaryCRN]
      ,[QualificationLevel]
      ,[NationalCourseCode]
      ,[RESIDENTIAL_STATUS]
      ,[ResidentialStatus]
      ,[CurrEMPstatus]
      ,[EmploymentStatus]
      ,[WorksInNSW]
      ,[ESPclient]
      ,[ESPOrganistaion]
      ,[EmploymentServicesProvider]
      ,[ESPreferral]
      ,[ESPReferralIDentifier]
      ,[IndigenousStatus]
      ,[Disability]
      ,[DisabilityAssessment]
      ,[PU_ID]
      ,[PersonalEmail]
      ,[TAFEemail]
      ,[TAFEID]
      ,[Mobile]
      ,[DataLoadDate]
      ,[OfferingStart]
      ,[OfferingEnd]
      ,[DtApplied]
      ,[DtEnrolled]
      ,[FacultyCode]
      ,[ProgressType]
      ,[DateFirstActive]
      ,[UniqueID]
  FROM [edw].[EBS_EnrolmentsAndFees]
GO
PRINT N'Creating View [OneEBS].[EBS_Progress_History]...';


GO


CREATE VIEW [OneEBS].[EBS_Progress_History] AS  
SELECT 
	  pr.people_units_id parent_id,
	  pr.rpr_sequence id,
	  pr.people_units_id,
	  pr.people_units_type,
	  pr.effective_date,
	  pr.actual_end_date,
	  pr.reg_registration_code,
	  pr.rpc_progress_type progress_status,
	  pr.rpr_sequence,
	  pr.rpc_type_name progress_code,
	  pr.reg_registration_number,
	  pr.created_by,
	  pr.created_date,
	  pr.updated_by,
	  pr.updated_date,
	  pr.fes_registration_number,
	  pr.fes_unit_instance_code,
	  pr.app_application_number,
	  pr.au_au_number,
	  pr.per_person_code,
	  pr.fes_cal_occurrence,
	  pr.rul_code,
	  pr.actioned_by,
	  pr.actioned_date,
	  pr.action_status,
	  pr.submitted_by,
	  pr.notes_id,
	  pr.batch_no,
	  pr.user_notified,
	  COALESCE(pc.fes_long_description, pc.fes_short_description) [description],
	  pc.student_status,
	  COALESCE(v.fes_long_description, v.fes_short_description) unit_type,
	  pu.person_code,
	  COALESCE(uio.long_description, ui.fes_long_description) course_description,
	  pu.progress_status unit_status,

	  --To_Char(pr.effective_date, 'DD/MM/YYYY') friendly_effective_date,
	  convert(date, pr.effective_date) as friendly_effective_date,
	  --To_Char(pr.created_date, 'DD/MM/YYYY') friendly_created_date,
	   convert(date, pr.created_date) as friendly_created_date,

	  concat(pr.fes_unit_instance_code , ' - ' , pr.fes_cal_occurrence , ' - ' , pr.effective_date) as  unique_order,
	  CASE pr.people_units_type
			WHEN 'E' THEN 'Enquiry'
			WHEN 'A' THEN 'Application'
			WHEN 'R' THEN 'Enrolment'
			ELSE NULL
	  END AS people_unit_type,
	  pr.cascade_aims,
	  pr.cascade_exams,
	  pr.cascade_registers,
	  pr.cascade_units,
	  pr.destination

FROM [OneEBS].[Progress_Records] pr
	INNER JOIN [OneEBS].[Progress_Codes] pc 
		ON pc.type_name = pr.rpc_type_name
	INNER JOIN [OneEBS].[Verifiers] v 
		ON pc.student_status = v.low_value 
		AND  v.rv_domain = 'PEOPLE_UNITS_TYPE'
	INNER JOIN [OneEBS].[People_Units] pu 
		ON pu.id = pr.people_units_id
	LEFT OUTER JOIN [OneEBS].[Unit_Instance_Occurrences] uio 
		ON uio.uio_id = pu.uio_id
	LEFT OUTER JOIN [OneEBS].[Unit_Instances] ui 
		ON uio.fes_uins_instance_code = ui.fes_unit_instance_code

WHERE isnull(pr.action_status,3) = 3 -- show only accepted progressions
GO
PRINT N'Creating View [OneEBS].[Note_Links]...';


GO
CREATE VIEW OneEBS.Note_Links
AS
SELECT [CREATED_BY]
      ,[CREATED_BY_PERSON_CODE]
      ,[CREATED_DATE]
      ,[ID]
      ,[INSTITUTION_CONTEXT_ID]
      ,[IS_READ]
      ,[NOTES_ID]
      ,[NOTE_TYPE]
      ,[PARENT_ID]
      ,[PARENT_TABLE]
  FROM [edw].[OneEBS_EBS_0165_NOTE_LINKS]
  WHERE _RecordCurrent = 1 AND _RecordDeleted = 0
GO
PRINT N'Altering Procedure [edw].[USP_RefreshEbsEnrolmentsAndFees]...';


GO



/*********************************************************************************************
-- ===========================================================================================
-- Description:	Populates the fact table [EBS].[EnrolmentsAndFees] from EDW ebs tables
Example:		EXEC UMD.[USP_RefreshEbsEnrolmentsAndFees 

SELECT count(*) from EBS.EnrolmentsAndFees;
SELECT * from EBS.EnrolmentsAndFees;

-- Change History
Date		Modified By			Remarks
31/05/2021	Marcelle Folkerts	Added additional Fields & PK

-- ===========================================================================================
*********************************************************************************************/

ALTER procedure [edw].[USP_RefreshEbsEnrolmentsAndFees] 
as
	begin

		----------------------------
		-- SET environment variables
		----------------------------
		set nocount on; -- the count is not returned
		set xact_abort on; -- if a Transact-SQL statement raises a run-time error, the entire transaction is terminated and rolled back.

		begin try

			----------------------------------------------------------------------------------------------------
			-- Get Current Fee Values (CFV)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#CFV') is not null DROP TABLE [#CFV]
			SELECT COALESCE(PEOPLE_UNIT_LINKS.PARENT_ID, FEES_LIST.RUL_CODE) as PU_ID,  
					SUM(ISNULL(FEES_LIST.AMOUNT,0)) CFee  
			INTO [#CFV]
			FROM OneEBS.FEES_LIST
				INNER JOIN OneEBS.FEE_TYPES 
					ON FEE_TYPES.FEE_TYPE_CODE = FEES_LIST.FES_FEE_TYPE AND FEE_TYPES.FEE_CATEGORY_CODE IN ('COMM','TAFEFEE','TVET','TVH')
				LEFT JOIN OneEBS.PEOPLE_UNIT_LINKS 
					ON PEOPLE_UNIT_LINKS.CHILD_ID = FEES_LIST.RUL_CODE
				INNER JOIN OneEBS.FEE_VALUES 
					ON FEE_VALUES.FEE_VALUE_NUMBER = FEES_LIST.FEE_VALUE_NUMBER

				WHERE FEES_LIST.FES_RECORD_TYPE = 'F'
				AND FEES_LIST.[STATUS] = 'F' 

				GROUP BY COALESCE(PEOPLE_UNIT_LINKS.PARENT_ID, FEES_LIST.RUL_CODE) 	;

			----------------------------------------------------------------------------------------------------
			-- Get Fee Waiver Values (FWV)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#FWV') is not null DROP TABLE [#FWV]
			SELECT DISTINCT COALESCE(PEOPLE_UNIT_LINKS.PARENT_ID, FEES_LIST.RUL_CODE) PU_ID,
					 STRING_AGG(WAIVER_VALUES.WAIVER_CODE, ', ') WITHIN GROUP (ORDER BY WAIVER_VALUES.WAIVER_CODE) as WC
			INTO [#FWV]
			FROM OneEBS.FEES_LIST
				INNER JOIN OneEBS.FEE_VALUES 
					ON FEE_VALUES.FEE_VALUE_NUMBER = FEES_LIST.FEE_VALUE_NUMBER
				INNER JOIN OneEBS.FEE_TYPES 
					ON FEE_TYPES.FEE_TYPE_CODE = FEES_LIST.FES_FEE_TYPE AND FEE_TYPES.FEE_CATEGORY_CODE IN ('COMM','TAFEFEE','TVET','TVH')
				INNER JOIN OneEBS.FEES_LIST_WAIVERS 
					ON FEES_LIST_WAIVERS.FEE_RECORD_CODE = FEES_LIST.FEE_RECORD_CODE
				LEFT JOIN OneEBS.PEOPLE_UNIT_LINKS 
					ON PEOPLE_UNIT_LINKS.CHILD_ID = FEES_LIST.RUL_CODE
				INNER JOIN OneEBS.WAIVER_VALUES
					ON WAIVER_VALUES.WAIVER_VALUE_NUMBER = FEES_LIST_WAIVERS.WAIVER_VALUE_NUMBER AND WAIVER_VALUES.WAIVER_CODE IS NOT NULL
			WHERE FEES_LIST.FES_RECORD_TYPE = 'F'
			AND FEES_LIST.[STATUS] = 'F' 
			AND COALESCE(PEOPLE_UNIT_LINKS.PARENT_ID, FEES_LIST.RUL_CODE) is not null

			GROUP BY COALESCE(PEOPLE_UNIT_LINKS.PARENT_ID, FEES_LIST.RUL_CODE);

			----------------------------------------------------------------------------------------------------
			-- Get Enrolment Waivers (EW)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#EW') is not null DROP TABLE [#EW]
			SELECT distinct ATTACHED_WAIVER_VALUES.RUL_CODE,
				 STRING_AGG(WAIVER_VALUES.WAIVER_CODE, ', ')
				WITHIN GROUP (ORDER BY WAIVER_VALUES.WAIVER_CODE) as WC
			INTO [#EW]
			FROM OneEBS.ATTACHED_WAIVER_VALUES
				INNER JOIN OneEBS.WAIVER_VALUES 
					ON WAIVER_VALUES.WAIVER_VALUE_NUMBER = ATTACHED_WAIVER_VALUES.WAIVER_VALUE_NUMBER
				WHERE ATTACHED_WAIVER_VALUES.RUL_CODE is not null
				GROUP BY ATTACHED_WAIVER_VALUES.RUL_CODE;

			----------------------------------------------------------------------------------------------------
			-- Get Location (LOC)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#LOC') is not null DROP TABLE [#LOC]
			SELECT  l.location_CODE as LocationCode
					, l.FES_SHORT_DESCRIPTION as LocationName
					, l.FES_LONG_DESCRIPTION as LocationDescription
					, i.InstituteCode AS InstituteCode 	
					, REPLACE(oup.fes_full_name, ' Institute','') as InstituteName
					, oupr.fes_full_name as Region 
			INTO [#LOC]
			FROM edw.OneEBS_EBS_0165_locations l 
				LEFT JOIN edw.OneEBS_EBS_0165_organisation_units ouc on ouc.organisation_code = l.organisation_code and ouc.organisation_type = 'CO' and ouc.[_RecordCurrent] = 1 /* College/Campus */ 
				LEFT JOIN edw.OneEBS_EBS_0165_org_unit_links oul on oul.secondary_organisation = ouc.organisation_Code and oul.[_RecordCurrent] = 1
				LEFT JOIN edw.OneEBS_EBS_0165_organisation_units oup on oup.organisation_code = oul.primary_organisation and oup.organisation_type = 'IN' and oup.[_RecordCurrent] = 1/* Institute */ 
				LEFT JOIN edw.OneEBS_EBS_0165_org_unit_links oulr on oulr.secondary_organisation = oup.organisation_Code and oulr.[_RecordCurrent] = 1
				LEFT JOIN edw.OneEBS_EBS_0165_organisation_units oupr on oupr.organisation_code = oulr.primary_organisation and oupr.organisation_type = 'REG' and oupr.[_RecordCurrent] = 1 /* Region */
				LEFT JOIN Reference.Institute i on right(oup.organisation_code,3) = i.InstituteID
			where isnumeric(l.location_code)=0 AND L.SITE_CODE IS NOT NULL
					and L.FES_ACTIVE = 'Y' and L.[_RecordCurrent] = 1;

			----------------------------------------------------------------------------------------------------
			-- Get Residential Address Values (RAV)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#RAV') is not null DROP TABLE [#RAV]
			SELECT PERSON_CODE,
				MAX(ADDRESS_CODE) as Row_ID
			INTO [#RAV]
			FROM [OneEBS].[Addresses]
			WHERE (END_DATE IS NULL OR (END_DATE IS NOT NULL AND END_DATE > getdate())) 
				AND PERSON_CODE IS NOT NULL 
				AND (START_DATE IS NULL OR (START_DATE IS NOT NULL AND START_DATE < getdate())) 
				AND OWNER_TYPE='P'
				AND ADDRESS_TYPE='RES'
				AND UPPER(ADDRESS_LINE_1) NOT LIKE '%DO NOT USE%'
			GROUP BY PERSON_CODE;
			
			----------------------------------------------------------------------------------------------------
			-- Get Date Applied Values (APV)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#APV') is not null DROP TABLE [#APV]
			SELECT PR.PEOPLE_UNITS_ID,
					MIN(PR.CREATED_DATE) DtApplied
			INTO [#APV]
			FROM [OneEBS].[Progress_Records] PR
			INNER JOIN [OneEBS].[Progress_Codes] PC
				ON PC.TYPE_NAME = PR.RPC_TYPE_NAME
			WHERE PC.STUDENT_STATUS='A'
			GROUP BY PR.PEOPLE_UNITS_ID;

			----------------------------------------------------------------------------------------------------
			-- Get Date Enrolled Values (ENV)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#ENV') is not null DROP TABLE [#ENV]
			SELECT PR.PEOPLE_UNITS_ID,
					MIN(PR.CREATED_DATE) DtEnrolled
			INTO [#ENV]
			FROM [OneEBS].[Progress_Records] PR
			INNER JOIN [OneEBS].[Progress_Codes] PC
				ON PC.TYPE_NAME = PR.RPC_TYPE_NAME
			WHERE PC.STUDENT_STATUS = 'R'
			GROUP BY PR.PEOPLE_UNITS_ID;


			----------------------------------------------------------------------------------------------------
			-- Get Main Data (EnrolmentFeeData)
			----------------------------------------------------------------------------------------------------
			
			IF object_id('tempdb..#EnrolmentFeeData') is not null DROP TABLE [#EnrolmentFeeData]
			SELECT L.Region,
					L.InstituteName as SubRegion,  --RTO,
					UIO.SLOC_LOCATION_CODE as [Location], -- CampusCode,
					PE.REGISTRATION_NO as LearnerNo,
					PE.PERSON_CODE as PersonCode,
					PE.SURNAME as Surname,
					PE.FORENAME as FirstName,
					PEOPLE_USI.USI,
					PEOPLE_USI.DATE_USI_VERIFIED,
					PE.DATE_OF_BIRTH as DateOfBirth,
					DATEDIFF(yy, PE.DATE_OF_BIRTH, COALESCE(PUS.START_DATE,UIO.FES_START_DATE)) 
						- CASE WHEN (MONTH(PE.DATE_OF_BIRTH) >= MONTH(COALESCE(PUS.START_DATE,UIO.FES_START_DATE)))  
								AND DAY(PE.DATE_OF_BIRTH) > DAY(COALESCE(PUS.START_DATE,UIO.FES_START_DATE)) THEN 1 ELSE 0 END as AgeAtEnrolment, --Age at Time of Enrolment in Years
					LOC.FES_LONG_DESCRIPTION as CampusName,
					FAC.FES_FULL_NAME as FacultyName,
					UIO.FES_UINS_INSTANCE_CODE as CourseCode,
					UIO.CALOCC_OCCURRENCE_CODE as CalOccCode,
					SUBSTRING(COALESCE(UI.PROSP_USER_8,UI.FES_LONG_DESCRIPTION),1,255) as CourseName,
					COALESCE(PUS.START_DATE,UIO.FES_START_DATE) as EnrolmentStartDate,
					COALESCE(PUS.END_DATE,UIO.FES_END_DATE) as EnrolmentEndDate,
					PU.PROGRESS_CODE as ProgressCode,
					PU.PROGRESS_DATE as ProgressDate,
					PROGRESS_CODES.FES_LONG_DESCRIPTION AS Progress,
					PU.DESTINATION as ReasonCode,
					prgres.FES_LONG_DESCRIPTION AS ProgressReason,
					COALESCE(PU.NZ_FUNDING,UIO.NZ_FUNDING) as FundingSource,
					Funding.FES_LONG_DESCRIPTION AS FundingDescription,
					PU.COMMITMENT_IDENTIFIER,
					pu.subsidy_status as CID_Status,
					pu.user_1 as A_T_Flag,
					APPT.FES_LONG_DESCRIPTION AS ApprenticeTrainee,
					TRA.FES_LONG_DESCRIPTION AS ApprenticeTraineeType,		
					PU.TRAINING_CONTRACT_IDENTIFIER as TCID,
					PU.UIO_ID,
					UIO.OFFERING_TYPE as OfferingType,
					OT.FES_LONG_DESCRIPTION AS OfferingTypeDesc,
					UIO.FES_USER_1 as OfferingCode,
					Teach.FES_FULL_NAME as TeachingSection,	
						
					--Fees
					PUF.STUDENT_FEE_AMOUNT as TSN_StudentFee,
					PUF.FEE_TYPE_INDICATOR as TSN_FeeTypeIndicator, 
					FTI.FES_LONG_DESCRIPTION AS TSN_FeeTypeIndicatorDesc,
					FWV.WC as FeeWaivers,	
					EW.WC as EnrolmentWaivers,	
					CFV.CFee AS EBS_CurrentFee,	  
					Case when CFV.CFee is null then 'N' else 'Y' end as ebsFeeExist,
					--End Fees
								
					PU.WHO_TO_PAY as WhoToPay,
					SUBSTRING(AD.UK_POST_CODE_PT1,1,5) as PostCode,
					AD.REGION as ResidentialState,
					AD.TOWN as ResidentialLocality,
					PE.HIGHEST_POST_SCHOOL_QUAL,
					PSQ.FES_LONG_DESCRIPTION AS PostSchoolQualification,
					PU.WELFARE_STATUS,
					CL.CRN as PrimaryCRN,
					CL.SECONDARY_CRN,
					QUAL.FES_LONG_DESCRIPTION AS QualificationLevel,
					UI.NATIONAL_COURSE_CODE,
					PE.RESIDENTIAL_STATUS,
					Residential.FES_LONG_DESCRIPTION AS ResidentialStatus,
					PE.CURREMPSTATUS ,
					Employment.FES_LONG_DESCRIPTION AS EmploymentStatus,
					PU.USER_5 as WorksInNSW,
					PU.IS_ESP_CLIENT as ESPclient,
					PU.ESP_ORGANISATION,
					ESP.FES_LONG_DESCRIPTION AS EmploymentServicesProvider,
					PU.IS_ESP_REFERRAL as ESPreferral,
					PU.ESP_REFERRAL_IDENTIFIER,
					indig.FES_LONG_DESCRIPTION AS IndigenousStatus,
					disab.FES_LONG_DESCRIPTION AS Disability,
					disas.FES_LONG_DESCRIPTION AS DisabilityAssessment,

					--Additional Fields added MF 31/05/2021
					PU.ID as PU_ID,
					PE.PERSONAL_EMAIL as PersonalEmail,
					PE.COLLEGE_EMAIL as TAFEemail,
					PE.COLLEGE_LOGIN as TAFEID,
					PE.MOBILE_PHONE_NUMBER as Mobile,
					GetDate() as DataLoadDate,
					UIO.FES_START_DATE as OfferingStart,					
					UIO.FES_END_DATE as OfferingEnd,
					APV.DtApplied,
					ENV.DtEnrolled,
					UIO.OWNING_ORGANISATION as FacultyCode,
					PROGRESS_CODES.STUDENT_STATUS as ProgressType,
					(SELECT MIN(PR.CREATED_DATE) 
						FROM [OneEBS].[Progress_Records] PR
						WHERE PR.RPC_PROGRESS_TYPE='A'
						AND PR.PEOPLE_UNITS_ID=PU.ID) DateFirstActive

			INTO [#EnrolmentFeeData]
			FROM OneEBS.PEOPLE PE
				INNER JOIN OneEBS.PEOPLE_UNITS PU
					ON PU.PERSON_CODE = PE.PERSON_CODE
					AND PU.UNIT_TYPE IN ('A','R')
				INNER JOIN OneEBS.UNIT_INSTANCE_OCCURRENCES UIO
					ON UIO.UIO_ID = PU.UIO_ID AND UIO.CALOCC_CALENDAR_TYPE_CODE = 'COURSE'
				INNER JOIN OneEBS.UNIT_INSTANCES UI
					ON UI.FES_UNIT_INSTANCE_CODE = UIO.FES_UINS_INSTANCE_CODE 
				LEFT JOIN OneEBS.PEOPLE_UNITS_SPECIAL PUS
					ON PUS.PEOPLE_UNITS_ID = PU.ID
					AND PU.SPECIAL_DETAILS = 'Y'
				LEFT JOIN OneEBS.PEOPLE_USI 
					ON PEOPLE_USI.PERSON_CODE = PE.PERSON_CODE
				LEFT JOIN OneEBS.LOCATIONS LOC
					ON LOC.LOCATION_CODE = UIO.SLOC_LOCATION_CODE
				LEFT JOIN OneEBS.ORGANISATION_UNITS FAC
					ON FAC.ORGANISATION_CODE = UIO.OFFERING_ORGANISATION
				LEFT JOIN OneEBS.ORGANISATION_UNITS Teach 
					ON Teach.ORGANISATION_CODE = UIO.OWNING_ORGANISATION 

				LEFT JOIN #CFV CFV
					ON CFV.PU_ID = PU.ID	
				LEFT JOIN #FWV	 FWV
					ON FWV.PU_ID = PU.ID
				LEFT JOIN #EW	 EW
					ON EW.RUL_CODE = PU.ID
				LEFT JOIN OneEBS.PEOPLE_UNITS_FINANCIAL PUF
					ON PUF.PEOPLE_UNITS_ID = PU.ID
				LEFT JOIN #APV APV
					ON APV.PEOPLE_UNITS_ID = PU.ID
				LEFT JOIN #ENV ENV
					ON ENV.PEOPLE_UNITS_ID = PU.ID

				LEFT JOIN #LOC L
					ON L.LocationCode = UIO.SLOC_LOCATION_CODE 
				LEFT JOIN	[OneEBS].[Verifiers] AS APPT
					ON	APPT.RV_DOMAIN = 'TRAINEE_CODES'
					AND	APPT.LOW_VALUE = pu.user_1
				LEFT JOIN  	[OneEBS].[Verifiers] AS TRA 
					ON	TRA.LOW_VALUE = PU.APPRENTICE_TRAINEE_TYPE
					AND	TRA.RV_DOMAIN = 'TRAINEE_TYPE'
				LEFT JOIN #RAV RAV
					ON RAV.PERSON_CODE=PE.PERSON_CODE
				LEFT JOIN [OneEBS].[Addresses] AD
					ON AD.ADDRESS_CODE = RAV.Row_ID
				LEFT JOIN [OneEBS].[People_Centrelink] CL
					ON CL.PERSON_CODE=PE.PERSON_CODE
				LEFT JOIN	[OneEBS].[Verifiers] OT
					ON OT.RV_DOMAIN = 'OFFERING_TYPE'
					AND OT.LOW_VALUE = UIO.OFFERING_TYPE	
				LEFT JOIN  	[OneEBS].[Verifiers] QUAL 
					ON QUAL.LOW_VALUE = UI.AWARD_CATEGORY_CODE
					AND QUAL.RV_DOMAIN = 'QUAL_AWARD_CATEGORY_CODE'
				INNER JOIN	[OneEBS].[Progress_Codes] PROGRESS_CODES
					ON PROGRESS_CODES.[TYPE_NAME] = PU.PROGRESS_CODE
					--AND PROGRESS_CODES.STUDENT_STATUS = 'R'
				LEFT JOIN  	[OneEBS].[Verifiers] AS prgres
					ON	prgres.LOW_VALUE = PU.DESTINATION
					AND	prgres.RV_DOMAIN = 'DESTINATION'
				LEFT JOIN	[OneEBS].VERIFIERS AS Residential 
					ON	Residential.LOW_VALUE = PE.RESIDENTIAL_STATUS
					AND	Residential.RV_DOMAIN = 'RESIDENTIAL_STATUS'
				LEFT JOIN   [OneEBS].VERIFIERS AS Employment
					ON	Employment.LOW_VALUE = PE.CURREMPSTATUS 
					AND	Employment.RV_DOMAIN = 'CURRENT_EMPLOYMENT_STATUS'
				LEFT JOIN   [OneEBS].VERIFIERS AS ESP
					ON	ESP.LOW_VALUE = PU.ESP_ORGANISATION 
					AND	ESP.RV_DOMAIN = 'EMPLOYMENT_SERVICE_PROVIDER'
				LEFT JOIN   [OneEBS].VERIFIERS AS FTI 
					ON	FTI.LOW_VALUE = PUF.FEE_TYPE_INDICATOR
					AND FTI.RV_DOMAIN = 'FEE_TYPE_INDICATOR'
				LEFT JOIN   [OneEBS].VERIFIERS AS indig
					ON	indig.LOW_VALUE = PE.INDIGENOUS_STATUS
					AND	indig.RV_DOMAIN = 'INDIGENOUS_IDENTIFIER'
				LEFT JOIN   [OneEBS].VERIFIERS AS disab
					ON disab.LOW_VALUE  = PE.LEARN_DIFF
					AND disab.RV_DOMAIN = 'DISABILITY_STATUS'  
				LEFT JOIN   [OneEBS].VERIFIERS AS disas
					ON disas.LOW_VALUE  = PE.DISABILITY_ASSESSMENT_TYPE
					AND disas.RV_DOMAIN = 'DISABILITY_ASSESSMENT_TYPE'
				LEFT JOIN   [OneEBS].VERIFIERS AS Funding
					ON Funding.RV_DOMAIN = 'FUNDING'
					AND Funding.LOW_VALUE = COALESCE(PU.NZ_FUNDING,UIO.NZ_FUNDING) 
				LEFT JOIN	[OneEBS].VERIFIERS AS PSQ
				ON			PSQ.RV_DOMAIN = 'QUAL_SINCE_17'
				AND			PSQ.LOW_VALUE = PE.POST_SCHOOL_QUALS

		WHERE  COALESCE(PUS.END_DATE,UIO.FES_END_DATE) >=  dateadd(MM,-72,getdate())  
				AND	UPPER(PE.SURNAME) NOT LIKE '%DO NOT USE%'
				AND UPPER(PE.FORENAME) NOT LIKE '%DO NOT USE%' ;



			----------------------------------------------------------------------------------------------------
			-- Begin Transaction.
			----------------------------------------------------------------------------------------------------
			
			begin transaction;

			----------------------------------------------------------------------------------------------------
			-- Populate EBS.EnrolmentsAndFees
			----------------------------------------------------------------------------------------------------

			TRUNCATE TABLE [edw].[EBS_EnrolmentsAndFees];   
			ALTER TABLE [edw].[EBS_EnrolmentsAndFees] DROP CONSTRAINT IF EXISTS PK_EnrolmentsAndFee ;  --MF 31/05/2021

			INSERT INTO [edw].[EBS_EnrolmentsAndFees] (
					Region,
					SubRegion,  
					[Location], 
					LearnerNo,
					PersonCode,
					Surname,
					FirstName,
					USI,
					DateUSIverified,
					DateOfBirth,
					AgeAtEnrolment, 
					CampusName,
					FacultyName,
					CourseCode,
					CalOccCode,
					CourseName,
					EnrolmentStartDate,
					EnrolmentEndDate,
					ProgressCode,
					ProgressDate,
					Progress,
					ReasonCode,
					ProgressReason,
					FundingSource,
					FundingDescription,
					CommitmentIdentifier,
					CID_Status,
					A_T_Flag,
					ApprenticeTrainee,
					ApprenticeTraineeType,		
					TCID,
					UIO_ID,
					OfferingType,
					OfferingTypeDesc,
					OfferingCode,
					TeachingSection,	
					TSN_StudentFee,
					TSN_FeeTypeIndicator, 
					TSN_FeeTypeIndicatorDesc,
					FeeWaivers,	
					EnrolmentWaivers,	
					EBS_CurrentFee,	  
					ebsFeeExist,
					WhoToPay,
					PostCode,
					ResidentialState,
					ResidentialLocality,
					HighestPostSchoolQual,
					PostSchoolQualification,
					WelfareStatus,
					PrimaryCRN,
					SecondaryCRN,
					QualificationLevel,
					NationalCourseCode,
					RESIDENTIAL_STATUS,
					ResidentialStatus,
					CurrEMPstatus,
					EmploymentStatus,
					WorksInNSW,
					ESPclient,
					ESPOrganistaion,
					EmploymentServicesProvider,
					ESPreferral,
					ESPReferralIDentifier,
					IndigenousStatus,
					Disability,
					DisabilityAssessment,
					PU_ID,
					PersonalEmail,
					TAFEemail,
					TAFEID,
					Mobile,
					DataLoadDate,
					OfferingStart,					
					OfferingEnd,
					DtApplied,
					DtEnrolled,
					FacultyCode,
					ProgressType,
					DateFirstActive 	)
			
			SELECT Region,
					SubRegion,  
					[Location], 
					LearnerNo,
					PersonCode,
					Surname,
					FirstName,
					USI,
					DATE_USI_VERIFIED as DateUSIverified,
					DateOfBirth,
					AgeAtEnrolment, 
					CampusName,
					FacultyName,
					CourseCode,
					CalOccCode,
					CourseName,
					EnrolmentStartDate,
					EnrolmentEndDate,
					ProgressCode,
					ProgressDate,
					Progress,
					ReasonCode,
					ProgressReason,
					FundingSource,
					FundingDescription,
					COMMITMENT_IDENTIFIER as CommitmentIdentifier,
					CID_Status,
					A_T_Flag,
					ApprenticeTrainee,
					ApprenticeTraineeType,		
					TCID,
					UIO_ID,
					OfferingType,
					OfferingTypeDesc,
					OfferingCode,
					TeachingSection,	
					TSN_StudentFee,
					TSN_FeeTypeIndicator, 
					TSN_FeeTypeIndicatorDesc,
					FeeWaivers,	
					EnrolmentWaivers,	
					EBS_CurrentFee,	  
					ebsFeeExist,
					WhoToPay,
					PostCode,
					ResidentialState,
					ResidentialLocality,
					HIGHEST_POST_SCHOOL_QUAL as HighestPostSchoolQual,
					PostSchoolQualification,
					WELFARE_STATUS as WelfareStatus,
					PrimaryCRN,
					SECONDARY_CRN as SecondaryCRN,
					QualificationLevel,
					NATIONAL_COURSE_CODE as NationalCourseCode,
					RESIDENTIAL_STATUS,
					ResidentialStatus,
					CURREMPSTATUS as CurrEMPstatus,
					EmploymentStatus,
					WorksInNSW,
					ESPclient,
					ESP_ORGANISATION as ESPOrganistaion,
					EmploymentServicesProvider,
					ESPreferral,
					ESP_REFERRAL_IDENTIFIER as ESPReferralIDentifier,
					IndigenousStatus,
					Disability,
					DisabilityAssessment,
					PU_ID,
					PersonalEmail,
					TAFEemail,
					TAFEID,
					Mobile,
					DataLoadDate,
					OfferingStart,					
					OfferingEnd,
					DtApplied,
					DtEnrolled,
					FacultyCode,
					ProgressType,
					DateFirstActive
			FROM #EnrolmentFeeData;

			ALTER TABLE [edw].[EBS_EnrolmentsAndFees] WITH CHECK ADD CONSTRAINT PK_EnrolmentsAndFee PRIMARY KEY CLUSTERED (UniqueID) ;  --MF 31/05/2021

			commit transaction;

			--------------------
			Cleanup:
			--------------------
			if object_id('tempdb..#CFV') is not null drop table [#CFV]
			if object_id('tempdb..#FWV') is not null drop table [#FWV]
			if object_id('tempdb..#EW') is not null drop table [#EW]
			if object_id('tempdb..#LOC') is not null drop table [#LOC]
			if object_id('tempdb..#RAV') is not null drop table [#RAV]
			if object_id('tempdb..#APV') is not null drop table [#APV]
			if object_id('tempdb..#ENV') is not null drop table [#ENV]
			if object_id('tempdb..#EnrolmentFeeData') is not null drop table [#EnrolmentFeeData]

	End Try
	Begin Catch
	if @@tranCount > 0
		Rollback
		Declare @err_num  int = @@ERROR
		Declare @err_desc varchar(500) = ERROR_MESSAGE()
		raiserror(@err_desc,@err_num,1)

	End Catch;
 END;
GO
PRINT N'Refreshing Procedure [UMD].[USP_RefreshUMDDataModel]...';


GO
EXECUTE sp_refreshsqlmodule N'[UMD].[USP_RefreshUMDDataModel]';


GO
PRINT N'Refreshing Procedure [compliance].[PopulatePeopleUnitLinks]...';


GO
EXECUTE sp_refreshsqlmodule N'[compliance].[PopulatePeopleUnitLinks]';


GO
--This SP will drop any masking from the Production environment.
EXEC dbo.spDropAllMasking
GO

GO
PRINT N'Update complete.';


GO
