name: $(Build.BuildId).$(date:yyyyMMdd)

pr:
  branches:
    include:
    - master
  paths:
    include:
    - sl-df-nonprod/*

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - sl-df-nonprod/*
    - DevOps/Pipelines/datafactory-deploy-pipeline-cicd.yml
    - DevOps/Pipelines/stage-datafactory-integration.yml

pool:
  vmImage: ubuntu-latest

stages:
# ---------------------------------------------------------------------------
# Build artifacts
- stage: 'build'
  jobs:
  # Use this section to pull in or out build jobs
  - template: Templates/job-copy-datafactory-arm.yml
    parameters:
      data_factory_name: 'sl-df-nonprod'
# ---------------------------------------------------------------------------
# Release to Non-Prod
- template: Templates/stage-datafactory-integration.yml
  parameters:
    #dependencies: ['uat'] # Used to define any stage dependencies
    stage_name: 'deploy_adf_nonprod'
    variable_template_name: npe-variables
    run_condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
# ---------------------------------------------------------------------------
# Release to Production
- template: Templates/stage-datafactory-integration.yml
  parameters:
    #dependencies: ['uat'] # Used to define any stage dependencies
    stage_name: 'deploy_adf_prod'
    variable_template_name: prd-variables
    run_condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

